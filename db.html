<html>
  <head>
    <link href="css/bootstrap.css" rel="stylesheet">
    <script type="text/javascript" src="js/jquery-1.12.2.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script src="js/fdb-all.min.js"></script>
  </head>
  <body>
    <table class="table table-hover">
      <thead>
        <tr>
          <td>id</td>
          <td>姓名</td>
          <td></td>
          <td></td>
        </tr>
      </thead>
      <tbody>
        <div class="template">
          <tr>
            <td>{id}</td>
            <td>{name}</td>
            <td><a class="btn btn-default detail" data-id={id}>detail</a></td>
            <td><a class="btn btn-default delete" data-id={id}>delete</a></td>
          </tr>
        </div>
      </tbody>
    </table>
      性別:<br>
      <input type="radio" name="gender" value="male"> Male<br>
      <input type="radio" name="gender" value="female"> Female<br>
      名子:<br>
      <input id="name" type="text" name="student"><br>
      年齡:<br>
      <input id="age" type="text" name="age"><br>
      <input id="submit" type="submit" value="輸入">
    <script>
      var last = 0;
      function rnd(min, max) {
        return Math.floor(Math.random() * max) + min;
      }
      $("#submit").click(submit);
      function submit(){
        if($($("input[name=gender]")[0]).prop("checked")){
          var gender = "male";
          $($("input[name=gender]")[0]).prop("checked",false);
        }else if($($("input[name=gender]")[1]).prop("checked")){
          var gender = "female";
          $($("input[name=gender]")[1]).prop("checked",false);
        }else{
          alert("資料不足");
          return;
        }
        var Stu = new subStu($("#name").val(),gender,$("#age").val(),last+1);
        studentCollection.insert(Stu);
        saveInfo();
        $("#name").val("");
        $("#gender").val("");
        $("#age").val("");
        var s = studentCollection.find();
        var length = studentCollection.find().length;
        last = studentCollection.find()[length-1].id;
        if(last===undefined){
          last = 0;
        }
        $("tbody").append("<tr><td>"+s[length-1]['id']+"</td><td>"+s[length-1]['name']+"</td><td>"+'<a class="btn btn-default detail" data-id="'+s[length-1]['id']+'">detail</a>'+"</td><td>"+'<a class="btn btn-default delete" data-id="'+s[length-1]['id']+'">delete</a>'+"</td></tr>");
      }
      $(".template").hide();
      var count = 0;
      var stuNum = 0;
      var names = ["apple","pen","pineapple","ppap","fool"];
      var subjects = ["English","Math","Chinese","History"];
      var genders = ["male","female"];
      var fdb = new ForerunnerDB();
      var db = fdb.db("04db2");
      var studentCollection = db.collection('students');
      var scoreCollection = db.collection('scores');
      loadInfo();
      function newStudent(num){
        for(var i = 1;i <= num;i = i+1){
          var Stu = new stu(i);
          stuNum = stuNum + 1;
          studentCollection.insert(Stu);
        }
        saveInfo();
      }
      function newScore(num){
        for(var i = 0;i < num;i = i+1){
          var Score = new score();
          scoreCollection.insert(Score);
        }
        saveInfo();
      }
      function subStu(name,gender,age,id){
        this.age = age;
        this.name = name;
        this.gender = gender;
        this.id = id;
        
      }
      function stu(id){
        this.age = rnd(0,100);
        this.name = names[rnd(0,4)];
        this.gender = genders[rnd(0,1)];
        this.id = id;
      }
      function score(){
        this.id = rnd(1,studentCollection.find().length);
        this.subject = subjects[rnd(0,3)];
        this.number = rnd(0,100);
      }
      function saveInfo(){
        studentCollection.save();
        scoreCollection.save();
      }
      function loadInfo(){
        studentCollection.load(read);
        scoreCollection.load(read);
      }
      function read(){
        var length = studentCollection.find().length;
        last = studentCollection.find()[length-1].id;
        if(last===undefined){
          last = 0;
        }
        count+=1;
        var s = studentCollection.find();
        if(count >= 2){
        for(var i = 0;i < studentCollection.find().length;i = i+1){
          $("tbody").append("<tr><td>"+s[i]['id']+"</td><td>"+s[i]['name']+"</td><td>"+'<a class="btn btn-default detail" data-id="'+s[i]['id']+'">detail</a>'+"</td><td>"+'<a class="btn btn-default delete" data-id="'+s[i]['id']+'">delete</a>'+"</td></tr>");
          }
        }
      }
      $("body").on("click", ".detail", function(event){
        var id = $(this).attr("data-id") / 1;
        var stuScore = db.collection("scores").find({id: id});
        var allScore = 0;
        for(var i = 0;i < stuScore.length;i+=1){
          allScore+=stuScore[i].number;
        }
        alert("總分:"+allScore+"平均:"+Math.round(allScore / stuScore.length,0));
      });
      $("body").on("click", ".delete", function(event){
        var sure = confirm("你確定嗎?");
        if(sure){
          var id = $(this).attr("data-id") / 1;
          studentCollection.remove({id: id});
          scoreCollection.remove({id: id});
          $(this).closest("tr").remove();
          saveInfo();
        }
      });
    </script>
  </body>
</html>
